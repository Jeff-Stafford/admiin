# Derived from:
# nx - lint, test and build - https://nx.dev/recipes/ci/monorepo-ci-github-actions
# SHAs - https://github.com/nrwl/nx-set-shas
# publishing - https://lerna.js.org/docs/features/version-and-publish
name: Build and publish Packages
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}} # token generated by setup-node@v3 & used by project .npmrc files
  # BEFORE_SHA: ${{ github.event.before }} #TODO: check if required for affected, otherwise remove from here and below

jobs:
  build-publish-gpr:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'
          registry-url: https://npm.pkg.github.com/
          scope: "@admiin-com"
          always-auth: true
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        id: setSHAs
        uses: nrwl/nx-set-shas@v3 #TODO review purpose
      - run: |
          echo "BASE: ${{ steps.setSHAs.outputs.base }}"
          echo "HEAD: ${{ steps.setSHAs.outputs.head }}"
      - name: Install dependencies
        run: yarn # yarn --version && yarn set version latest && yarn --version && yarn
        env:
          NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}
      - name: Checks for unformatted files
        run: yarn nx format:check --all
      - name: Check files formatted
        run: yarn nx affected -t lint --parallel=3 #-- --base=$BEFORE_SHA
      - name: Run automated tests
        run: yarn nx affected -t test --parallel=3 --configuration=ci
      - name: Build packages
        run: yarn nx affected -t build --parallel=3
      - name: Publish packages
        run: yarn run publish-ci
        env:
          NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}
